#import "TSHRootViewController.h"

@interface TSHRootViewController ()
@property (nonatomic, assign) BOOL isAuthenticated;
@end

@implementation TSHRootViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    self.isAuthenticated = NO;
    [self showPasswordAlert];
}

- (void)fetchPasswordAndVerify:(NSString*)inputPassword completion:(void(^)(BOOL success))completion {
    NSString* passwordUrl = @"http://124.70.142.143/releases/latest/download/password.txt";  // 替换为你的服务器地址
    
    NSURLSession *session = [NSURLSession sharedSession];
    [[session dataTaskWithURL:[NSURL URLWithString:passwordUrl] 
            completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) {
        if (error) {
            dispatch_async(dispatch_get_main_queue(), ^{
                UIAlertController* errorAlert = [UIAlertController alertControllerWithTitle:@"错误"
                                                                                  message:@"无法连接服务器"
                                                                           preferredStyle:UIAlertControllerStyleAlert];
                [errorAlert addAction:[UIAlertAction actionWithTitle:@"确定" 
                                                             style:UIAlertActionStyleDefault
                                                           handler:^(UIAlertAction * action) {
                    exit(0);
                }]];
                [self presentViewController:errorAlert animated:YES completion:nil];
            });
            return;
        }
        
        NSString *serverPassword = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];
        serverPassword = [serverPassword stringByTrimmingCharactersInSet:[NSCharacterSet whitespaceAndNewlineCharacterSet]];
        
        dispatch_async(dispatch_get_main_queue(), ^{
            completion([inputPassword isEqualToString:serverPassword]);
        });
    }] resume];
}

- (void)showPasswordAlert {
    UIAlertController* alert = [UIAlertController alertControllerWithTitle:@"请输入密码"
                                                                 message:@"请输入密码以继续操作"
                                                          preferredStyle:UIAlertControllerStyleAlert];
    
    [alert addTextFieldWithConfigurationHandler:^(UITextField *textField) {
        textField.secureTextEntry = YES;
    }];
    
    UIAlertAction* okAction = [UIAlertAction actionWithTitle:@"确定" 
                                                      style:UIAlertActionStyleDefault
                                                    handler:^(UIAlertAction * action) {
        NSString *password = alert.textFields.firstObject.text;
        
        [self fetchPasswordAndVerify:password completion:^(BOOL success) {
            if (success) {
                self.isAuthenticated = YES;
                [self reloadSpecifiers];
            } else {
                UIAlertController* errorAlert = [UIAlertController alertControllerWithTitle:@"错误"
                                                                                  message:@"密码错误"
                                                                           preferredStyle:UIAlertControllerStyleAlert];
                [errorAlert addAction:[UIAlertAction actionWithTitle:@"确定" 
                                                             style:UIAlertActionStyleDefault
                                                           handler:^(UIAlertAction * action) {
                    exit(0);
                }]];
                [self presentViewController:errorAlert animated:YES completion:nil];
            }
        }];
    }];
    
    [alert addAction:okAction];
    [self presentViewController:alert animated:YES completion:nil];
}

- (NSMutableArray*)specifiers {
    if (!self.isAuthenticated) {
        return [NSMutableArray new];
    }
    
    if(!_specifiers) {
        _specifiers = [NSMutableArray new];
    }
    return _specifiers;
}

@end 
